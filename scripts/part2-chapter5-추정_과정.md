# Chapter5. 추정 과정
## 5.1. 추정값 계산 (계산 4단계 중 3단계)
3단계인 '추정값 계산' 식을 살펴보자.

$$
\hat{x}_k = \hat{x}_{k}^- + K_k(z_k - H \hat{x}_k^-)
$$

위 식을 변형하면 아래와 같다. 여기서 $I$는 단위 행렬(Identity Matrix)이며, 이후 비교를 위해 식ⓐ에서 $H$를 $I$로 가정하고 식을 전개했다.

$$
\begin{aligned}
\hat{x}_k &= \hat{x}_{k}^- + K_k(z_k - H \hat{x}_k^-) \\
&= \hat{x}_{k}^- + K_k z_k - K_k H \hat{x}_k^- \\
&= (I - K_k H)\hat{x}_{k}^- + K_k z_k \qquad \cdots(ⓐ) \\
&= (I - K_k I)\hat{x}_{k}^- + K_k z_k \\
&= (I - K_k)\hat{x}_{k}^- + K_k z_k
\end{aligned}
$$

이때 1차 저주차 필터 식을 상기해보고, $\alpha$ 대신 $(1-K)$를 대입해 정리해보면

$$
\begin{aligned}
\bar{x}_k &= \alpha \bar{x}_{k-1} + (1-\alpha) x_k \\
&= (1-K)\bar{x}_{k-1} + K {x}_k \qquad \cdots(ⓑ)
\end{aligned}
$$

ⓐ식과 ⓑ식을 비교해보면 그 형태가 매우 유사함을 알 수 있다.

* 칼만 필터: $ \hat{x}_k = (I - K_k)\hat{x}_{k}^- + K_k z_k $
* 1차 저주파 통과 필터: $ \bar{x}_k = (1-K)\bar{x}_{k-1} + K {x}_k$

1차 저주파 통과 필터가 '직전 추정값과 측정값에 각각 가중치를 곱해 더하여 이번 추정값을 계산'하는 것처럼, 칼만필터는 '예측값과 측정값에 각각 가중치를 곱해 더하여 이번 추정값을 계산'한다.

> 앞서 $H$를 단위행렬로 가정하였으나 실제로는 그렇지 않다. 다만 칼만필터가 1차 저주파 통과 필터와 유사한 흐름을 보인다는 점만 기억하자.

## 5.2. 변하는 가중치 (계산 4단계 중 2-3단계)
직전에 정리한 식에 의거하면 1차 저주파 통과 필터의 가중치 $\alpha$와 유사한 기능을 하는 것이 $K_k$이다. 이는 칼만 이득(Kalman gain)이라는 변수이며 2단계인 '칼만 이득 계산'에서 계산한다. 식을 살펴보면 딱히 주의할 내용 없이 단순 계산이다.

$$
K_k = P_k^- H^T (H P_k^- H^T + R)^{-1}
$$

1차 저주파 통과 필터와의 차이점은, 1차 저주파 통과 필터에서 $\alpha$ 값은 사용자가 미리 지정한 고정된 상수값인 반면, 칼만 필터에서 칼만 이득은 알고리즘을 반복하며 매번 갱신되는 값, 즉 변하는 가중치라는 점이다.

3단계 식을 다시 써보면 아래와 같다.

$$
\hat{x}_k = \hat{x}_{k}^- + K_k(z_k - H \hat{x}_k^-)
$$

$K_k$가 아닌 다른 변수들은 어떤 의미를 가지는지 보자. 예측값($\hat{x}_{k}^-$)은 1단계인 예측 단계에서 계산한 값이며, 측정값($z_k$)은 알고리즘으로 입력되는 값이다. $H$는 행렬로서 칼만 필터를 설계하는 단계에서 미리 결정하는 시스템 모델 변수이다.

## 5.2. 오차 공분산 계산 (계산 4단계 중 4단계)
4단계 식을 상기하면 아래와 같다.

$$
P_k = P_k^- - K_k H P_k^-
$$

여기서 주목할 것은 식의 계산이 아닌, '추정값과 참값의 차이를 오차 공분산으로 계산한다'는 점이다. $P_k$가 클수록 추정 오차가 크다는 뜻이다. 가끔 칼만 필터의 출력으로 오차 공분산도 내보내는 경우도 있다고 한다.

### 오차 공분산 $P_k$

$x_k$라는 변수가 있을 때, 추정값($\hat{x}_{k}$)과 오차 공분산($P_k$)은 다음과 같은 관계를 가지며, 이는 곧 $x_k$ 변수가 평균이 $\hat{x}_{k}$이고 공분산이 $P_k$인 정규분포(normal distribution)을 따른다는 의미이다.

$$
x_k \sim N(\hat{x}_{k}, P_k)
$$

$P_k$가 추정 오차를 의미하고 그 값이 작을수록 오차가 작다는 건, 가능한 $x_k$의 값들이 평균에 몰려있다는 뜻이다.

### 오차 공분산의 개념
오차 공분산을 아래와 같이 정의된다. $E{}$는 괄호 내 변수의 평균을 구함을 의미하고, $x_k$는 참 값을, $\hat{x}_k$는 추정값을 의미한다. 따라서 $\left( x_k - \hat{x}_k \right)$는 추정오차가 된다.

$$
P_k = E \left\{ \left( x_k - \hat{x}_k \right) \left( x_k - \hat{x}_k \right)^T \right\}
$$

위 식처럼 오차 공분산은 추정 오차의 제곱을 평균한 값을 말한다. 오차 공분산이 클수록 추정오차도 큰 이유이기도 하다.